CHANGE LOG FOR UNIFIED 3DVAR CODE
-------------------------------------------
Author(s)   :  Lidia Cucurull, John Derber, Daryl Kleist,
               Shun Liu, Russ Treadon
Reviewer(s) :  Russ Treadon
Date        :  17 October 2006
NCEP CVS tag:  this release:  ncep-gsi-2006_09 (no tag update)



REASON FOR CHANGES
------------------
Changes are made to the gsi code, fix files, and script for the following
reasons:  (listing  below not given in any particular order)

 a) Addition of sensible temperature for observations with no valid
    moisture observation
 b) Changes to moisture analysis - limit saturated values near model top
 c) Changes to step size calculation
 d) Code clean up
 e) Reformulate second dynamical constraint
 f) Generalize GPS RO operators to work with pressure.  No longer tied
    to a given vertical coordinate system
 g) Fix bugs.  Major bug in stpbend.f90 prevent routine from working
    correctly
 h) Extend MPI_IO capability to GOES sounder and AMRSE.  For AMSRE change
    required change in underlying manner in which file read.  MPI_IO
    version of read does not reproduce results from serial read.
 i) Add option to compute 10m wind factor using existing surface model
    in GSI or GFS surface physics routine.  10m wind factor is written
    out to surface analysis file
 j) Allow limq to be exercised when using qoption=2
 k) Add WRF source code to wrf_binary_interface.F90 to allow compilation
    with fewer WRF library and module dependencies
 l) Update scripts to work on new NCEP CCS
 m) Replace virual with sensible temperature in precipitation related
    routines
 n) Fix bug in setupsrw.f90



SPECIAL NOTES
-------------
The following points should be noted with regards to the above
code changes.  The lettering below, if any, corresponds to the
"REASON FOR CHANGES" for lettering above:

 i) Calculation of 10m wind factor within GSI code is controlled via
    SETUP namelist variable ifact10.  Possible values for ifact10 are
       ifact10 = 1 compute using GFS surface physics
       ifact10 = 2 compute using MM5 surface physics
       ifact10 = 0 or any other value - DO NOT recompute - use value
                 from guess file
    The default value for ifact10 is 0 ... do not recompute the 10m
    wind factor.  The 10m wind factor, possibly updated, it written
    to the surface analysis file, "sfcanl.gsi"

 j) Users exercising qoption=2 must remember to set factqmin=0.0 and
    factqmax=0.0 if they want limq to remain off.  Previous GSI releases
    forced factqmin=0.0=factqmax when qoption=2.  This release removes
    this restriction.

 l) On the new NCEP CCS users must specify X=the number of CPUs per process
    and YYYY=the ammount of memory (in Mb) that each process will use.  
    These are specified in the LoadLeveler premable via the 

    #@ resources = consumablecpus(X) consumablememory(YYYY MB)"

    Thus far the GSI has been run without threads so the consumablecpus is
    1.  The consumablememory depends on the size of the guess and data
    files.  The consumablememrory specified in the rungsi*sh scripts included
    in this update are only a rough guide.  Users are encouraged to look
    at the hpmcount output at the end of the GSI stdout file to determine
    to proper amount of memory to request.   One can do this using grep, 
    sort, and tail on the stdout output.  For example,

$ grep -i "maximum resident set size" stdout.anl.2006091112|sort -n -k7|tail -1
  42: Maximum resident set size                    : 727240 Kbytes

    Convert this number to Mb and add 10-15% to get a reasonable estimate
    for the amount of memory to request.  For the example above

    727240 Kb * 1 Mb/1024 Kb = 710.2 Mb + 10%(710.2 Mb) = 781.2 Mb.
    Round this to 800 Mb.

    Bear in mind that as you change the resolution of the analysis and/or
    add/remove the amount of data which you are processing, you shold adjust
    the ConsumableMemory request accordingly.

    Requesting too much memory not only wastes computer resources, it can
    also decrease the throughput of all jobs on the machine as each job
    sits in the queue longer to get the requested memory.



EXPECTED DIFFERENCES
--------------------
The following differences are expected when comparing GSI output from
this release from that from previous releases.  The lettering below
corresponds to the "REASON FOR CHANGES" for lettering above:

 a) In-situ temperature observations without a valid moisture observation
    are now processed as sensible observation.  In previous GSI releases
    the model guess was used to convert the observed sensible temperature
    to a virtual temperature which was then assimilated.  This conversion
    to virtual temperature is no longer needed.  The result for the 
    standard GSI test cases is to reduce the initial penalty for 
    temperature observations.



FILES REMOVED
-------------
   NONE



FILES ADDED
-----------
   compute_fact10.f90       - compute 10m wind factor using NCEP GFS physics
   jcrescale.f90            - rescale divergence and ageostrophic vorticity
                              tendencies
   tv_to_tsen.f90           - get sensible temperature from virtual temperature



FILES MODIFIED
--------------   
   calctends_ad.f90         - include pressure and areal-ave weightings
   calctends_tl.f90         - add rescaling to divergence tendency 
                              formulation; correct bug in tracer advection
                              terms
   compute_derived.f90      - add option to compute 10m wind factor
   genqstat.f90             - modify to limit saturated values near top
   genstats_gps.f90         - replace superobs factor for obs in a top (non-
                              full) layer
   gsimain.F90              - add ifact10 to namelist SETUP to control 
                              10m wind calculation; modify code to allow
                              limq to be exercised with qoption=2;
                              set tendsflag and switch_on_derivatives if
                              not set and processing precipitation data
   guess_grids.f90          - add sfcmod_gfs, sfcmod_mm5 logical flags for 
                              use with load_fact10; add new routine 
                              load_fact10; add ln(ges_prsi) array
   intall.f90               - add sensible temperatures for conventional 
                              temperature observations; use sensible 
                              temperature in intpcp call
   intbend.f90              - generalize code to use pressure in vertical;
                              modify to use surface pressure
   intrad.f90               - update (correct) comments
   intref.f90               - generalize code to use pressure in vertical;
                              modify to use surface pressure
   intspd.f90               - correct bug
   intt.f90                 - add sensible temperature for conventional 
                              temperature observations
   jcmod.f90                - include pressure and areal-ave weightings
   mpi_bufr_mod.F90         - remove debug line of code
   ncepgfs_io.f90           - pull sfc_rough (%zorl) from GFS surface file;
                              write 10m wind factor to output surface file
   obsmod.f90               - add logical flag tv_ob; clean up data handling
                              for gspro data
   pcgsoi.f90               - add check on "b"
   pcp_k.f90                - replace virtual temperature with sensible
   prewgt.f90               - change minimum moisture variance
   read_airs.f90            - clean up code (replace maxinfo with nreal)
   read_amsre.f90           - replace serial bufr i/o with parallel bufr
                              (mpi_io) i/o.  NOTE:  In making this change,
                              the mpi_io read_amsre.f90 does not reproduce
                              the results of the serial read routine
   read_goesndr.f90         - replace serial bufr i/o with parallel bufr
                              (mpi_io) i/o
   read_guess.f90           - add sfc_rough as variable; add call load_fact10
   read_obs.f90             - add mpi_io for amsre and goes sounder; remove
                              code to tendsflag and switch_on_derivatives 
                              when precipitation data present
   read_prepbufr.f90        - set qtflg properly to allow sensible 
                              temperatures to be processes as sensible
                              by setupt.f90
   read_ssmi.f90            - replace serial bufr i/o with parallel bufr
                              (mpi_io) i/o
   read_ssmis.f90           - replace serial bufr i/o with parallel bufr 
                              (mpi_io) i/o
   setupbend.f90            - use geopotential heights at intermediate
                              levels instead of midpoint levels; remove psges,
                              generalize minimization terms to pressure;
                              penalize high level obs; new QC checks; remove
                              remove obs above 30 km; add b_tkges; remove
                              dtime; improve obs pressure calculation for
                              diagnostics; increase the extended atmosphere
                              from 6 to 10 levels
   setuppcp.f90             - replace virtual temperature with sensible 
                              temperature
   setuprad.f90             - fix bug in array index for goesimgr qc; clean
                              up code
   setupref.f90             - use geopotential heights at intermediate levels
                              instead of mid layers; remove dlnp; new QC 
                              checks; penalize high elevation obs; remove 
                              termt1; modify the adjoint terms to generalize
                              vertical coordinate; remove obs above 30km; 
                              remove psges and zsges
   setupsrw.f90             - fix bug (should square data(ihat2,i))
   setupt.f90               - add ability to process sensible or virtual
                              temperature observations as reported; add 10m 
                              wind factor to sfc_wtq_fwd call
   sfc_model.f90            - add sensible or virtual temperature dependency
                              on iqtflg; add 10m wind factor as routine 
                              output
                              changed from ln(ps) to ps (cb)
   stpbend.f90              - modify output for b1 and b3; generalize vertical
                              coordinate to pressure; use surface pressure;
                              fix array index bug in gpsptr%ij
   stpcalc.f90              - modify output from nonlinear operators to make
                              same as linear operators; add sensible
                              temperature for conventional observations
                              of call to normal_rh_to_q to correct error in 
                              tendency computations (see intall.f90 above);
                              use sensible temperature in stppcp call
   stpdw.f90                - modify output for b1 and b3
   stplimq.f90              - modify output for b1 and b3
   stpoz.f90                - modify output for b1 and b3
   stppcp.f90               - modify output for b1 and b3
   stpps.f90                - modify output for b1 and b3
   stppw.f90                - modify output for b1 and b3
   stpq.f90                 - modify output for b1 and b3
   stprad.f90               - modify output for b1 and b3
   stpref.f90               - modify output for b1 and b3; generalize vertical
                              coordinate to pressure; use surface pressure
   stprw.f90                - modify output for b1 and b3
   stpspd.f90               - modify output for b1 and b3
   stpsrw.f90               - modify output for b1 and b3
   stpsst.f90               - modify output for b1 and b3
   stpt.f90                 - modify output for b1 and b3; add sensible 
                              temperature
   stpw.f90                 - modify output for b1 and b3
   wrf_binary_interface.F90 - add WRF source code to reduce dependency on WRF
                              libraries and modules



MAKEFILE CHANGES
----------------
The following changes are made to Makefile and Makefile.dependencies:
 a) Makefile
     - add compute_fact10.f90, jcrescale.f90, tv_to_tsen.f90

 b) Makefile.dependency
     - update dependencies based on code changes above
 c) Makefile.conf.AIX
     - replace wx20rt references to libraries and modules to those in nwprod
     - reduce number of WRF libary and module dependencies
     - update -qarch=pwr4 to -qarch=pwr5
     - redefine CC=/usr/vac/bin/cc_r since default cc not defined



SCRIPT CHANGES
---------------
The folowing changes are made to the rungsi*sh scripts

 a) Changes common to all scripts
    - add "#@ resources = consumablecpus(X) consumablememory(YYYY MB)" to 
      LoadLeveler preamble.   Please read the item l) under SPECIAL NOTES
      to more information regarding Cpus and Memory.
    - replace /nfsuser paths with appropriate paths for NCEP CCS mist

      conventional obs at same location (dfact,dfact1)  Formula is 
      1.-(1-dfact)*((delta Time between obs)/dfact1)**2.  
      So if dfact = 1 or delta Time is zero, obs are averaged.  
      As dfact gets less than one or the time between the obs increases, 
      the downweighting decreases.  Default values for dfact and dfact1 
      are 0. and 3..  Currently used values are 0.75 and 3.0
    - Add noiqc logical flag to OBSQC.  Default value is .false. which
      means to honor OIQC quality marks.  If running with variational 
      qc on, suggested value for noiqc is .true.  That is, allow all 
      data in regardless of OIQC flags.
    - Add new namelist,STRONGOPTS to control strong constraint.

Below are script specific changes in addition to the changes above
 b) rungsi_global.sh
    - set factqmin=0.0,factqmax=0.0 (was 1.0 for each).  This is needed
      since qoption=2 no longer resets factqmin and factqmax to zero.
      The rungsi_regional_nmm_*.sh scripts uses qoption=2
    - Add logic to look for linear gaussian grid surface files.  If 
      present, script skips global_chgres.   T382 surface files for 
      2006091112 test case are now available on linear grid.

 c) rungsi_regional_nmm_binary.sh and rungsi_regional_nmm_netcdf.sh
    - set factqmin=0.0,factqmax=0.0 (was 1.0 for each).  This is needed 
      since qoption=2 no longer resets factqmin and factqmax to zero.
      The rungsi_regional_nmm_*.sh scripts uses qoption=2



FIX FILE CHANGES
----------------
The following changes are made to fix files:

 a) global_berror.l64y386.f77, global_berror.l64y96.f77 
    - treatment of moisture in statistic code update to be consistent
      with treatment in analysis


GLOBAL NCEP T382L64 TEST
------------------------
Script  :  /global/save/wx20rt/gsi_anl/sorc/gsi_cvs.200610/rungsi_global.sh
Old code:  /global/save/wx20rt/gsi_anl/sorc/gsi_cvs.200609.mist
New code:  /global/save/wx20rt/gsi_anl/sorc/gsi_cvs.200610

Maximum resident set size
old :  1007036 Kbytes
new :  1059192 Kbytes
olde:  1023944 Kbytes
newe:  1077180 Kbytes
new2:  1105320 Kbytes

Wall clock (100 tasks, blocking=unlimited)
old : 1755.436345 seconds
new : 1777.884263 seconds
olde: 1823.747317 seconds
newe: 1760.132228 seconds
new2: 2247.993402 seconds
 
Output from the first iteration of the minimization
old : penalty,grad ,a,b=   1   0 0.513769751835154719E+06 0.482808212569793593E+07 0.526584133859612190E-02 0.000000000000000000E+00
new : penalty,grad ,a,b=   1   0 0.513755909042000712E+06 0.482198242058073916E+07 0.516229059069418187E-02 0.000000000000000000E+00
olde: penalty,grad ,a,b=   1   0 0.512839706786271883E+06 0.458798594813397434E+07 0.644200029695958173E-02 0.000000000000000000E+00
newe: penalty,grad ,a,b=   1   0 0.512825863993117877E+06 0.457950524747824576E+07 0.632280481003957926E-02 0.000000000000000000E+00
new2: penalty,grad ,a,b=   1   0 0.512825863993117877E+06 0.457950524747824576E+07 0.620270554786254286E-02 0.000000000000000000E+00

Output from the final iteration of the minimization
old : penalty,grad ,a,b=   2 100 0.340684455841896124E+06 0.238029381969880927E+01 0.124152009980191009E-02 0.814187892204001618E-01
new : penalty,grad ,a,b=   2 100 0.335058386800460110E+06 0.159253528351698725E+01 0.400274214492972197E-02 0.764812912229291042E+00
olde: penalty,grad ,a,b=   2 100 0.343910359529427544E+06 0.142306602861812976E+02 0.188842790113109057E-02 0.113115289014810405E+01
newe: penalty,grad ,a,b=   2 100 0.338382633882733993E+06 0.199375779869053749E+01 0.780934812288699119E-02 0.496441709015790156E+00
new2: penalty,grad ,a,b=   2 100 0.340725260166427528E+06 0.318042328491250942E+03 0.594913773680076901E-03 0.581734645159969976E+00

NOTES:
 a) The difference in the initial penalties is in the temperature
    penalty term.  The temperature forward operator in the new
    code processes observations according to how they are reported
    - sensible or virtual.  The old code converts all temperature
    observations to virtual.  For those observations without a
    usable moisture value, the model guess is interpolated to the
    temperature observation and used to convert the reported
    sensible temperature to virtual.
 b) "e" runs read every FOV AIRS bufr file instead of center 
    spot AIRS bufr file
 c) new2 run uses JC2 instead of JC1 



REGIONAL NCEP NMM BINARY TEST
-----------------------------
Script  :  /global/save/wx20rt/gsi_anl/sorc/gsi_cvs.200610/rungsi_regional_nmm_binary.sh
Old code:  /global/save/wx20rt/gsi_anl/sorc/gsi_cvs.200609.mist
New code:  /global/save/wx20rt/gsi_anl/sorc/gsi_cvs.200610

Maximum resident set size
old :  713976 Kbytes
new :  727240 Kbytes

Wall clock (48 tasks, blocking=unlimited)
old :  542.759497 seconds
new :  614.472137 seconds

Output from the first iteration of the minimization
old : penalty,grad ,a,b=   1   0 0.187121845542797004E+06 0.486901693190044910E+07 0.303801340447691507E-02 0.000000000000000000E+00
new : penalty,grad ,a,b=   1   0 0.187103368839482748E+06 0.487544519427950401E+07 0.303875409506350943E-02 0.000000000000000000E+00

Output from the final iteration of the minimization
old : penalty,grad ,a,b=   2  50 0.960938313547693688E+05 0.830564239584447591E+03 0.413314770932404242E-02 0.470510979234448568E+00
new : penalty,grad ,a,b=   2  50 0.962535120848942315E+05 0.675902926897127600E+03 0.240290883991081889E-02 0.335188154622157064E+00

NOTES:
 a) The difference in the initial penalties is in the temperature
    penalty term.  The temperature forward operator in the new
    code processes observations according to how they are reported 
    - sensible or virtual.  The old code converts all temperature
    observations to virtual.  For those observations without a
    usable moisture value, the model guess is interpolated to the 
    temperature observation and used to convert the reported 
    sensible temperature to virtual.



REGIONAL NCEP NMM NETCDF TEST
-----------------------------
Script  :  /global/save/wx20rt/gsi_anl/sorc/gsi_cvs.200610/rungsi_regional_nmm_netcdf.sh
Old code:  /global/save/wx20rt/gsi_anl/sorc/gsi_cvs.200609.mist
New code:  /global/save/wx20rt/gsi_anl/sorc/gsi_cvs.200610

Maximum resident set size
old :  237328 Kbytes
new :  245748 Kbytes

Wall clock (24 tasks, blocking=unlimited)
old :  175.715331 seconds
new :  209.112832 seconds


Output from the first iteration of the minimization
old : penalty,grad ,a,b=   1   0 0.205192011848016555E+05 0.217149646730661904E+07 0.540981131053191685E-03 0.000000000000000000E+00
new : penalty,grad ,a,b=   1   0 0.205174943336266333E+05 0.207874895993138477E+07 0.543719336772396987E-03 0.000000000000000000E+00

Output from the final iteration of the minimization
old : penalty,grad ,a,b=   2  50 0.109431042130754377E+05 0.515284395337168206E+02 0.372586366074004671E-02 0.741882904260171006E+00
new : penalty,grad ,a,b=   2  50 0.109370588507374250E+05 0.653085123910422141E+02 0.314267468820109445E-02 0.159681664119537037E+01

NOTES:
 a) The difference in the initial penalties is in the temperature
    penalty term.  The temperature forward operator in the new
    code processes observations according to how they are reported
    - sensible or virtual.  The old code converts all temperature
    observations to virtual.  For those observations without a
    usable moisture value, the model guess is interpolated to the
    temperature observation and used to convert the reported
    sensible temperature to virtual.



REGIONAL NCEP MASS BINARY TEST
------------------------------
Script  :  /global/save/wx20rt/gsi_anl/sorc/gsi_cvs.200610/rungsi_regional_mass_binary.sh
Old code:  /global/save/wx20rt/gsi_anl/sorc/gsi_cvs.200609.mist
New code:  /global/save/wx20rt/gsi_anl/sorc/gsi_cvs.200610

Maximum resident set size
old :  284924 Kbytes
new :  285524 Kbytes

Wall clock (24 tasks, blocking=unlimited)
old :  194.949925 seconds
new :  198.950047 seconds

Output from the first iteration of the minimization
old : penalty,grad ,a,b=   1   0 0.863229450587879728E+04 0.145824940734292218E+07 0.317674743571258922E-03 0.000000000000000000E+00
new : penalty,grad ,a,b=   1   0 0.863206525322216658E+04 0.145731663513276842E+07 0.317583350762707100E-03 0.000000000000000000E+00

Output from the final iteration of the minimization
old : penalty,grad ,a,b=   2  50 0.338761546121559877E+04 0.281357337582482103E+03 0.409692812421676416E-02 0.501425449050316718E+00
new : penalty,grad ,a,b=   2  50 0.338404075934520279E+04 0.486032460981851443E+03 0.108483550805903639E-02 0.118266004509059686E+01

NOTES:
 a) The difference in the initial penalties is in the temperature
    penalty term.  The temperature forward operator in the new
    code processes observations according to how they are reported
    - sensible or virtual.  The old code converts all temperature
    observations to virtual.  For those observations without a
    usable moisture value, the model guess is interpolated to the
    temperature observation and used to convert the reported
    sensible temperature to virtual.



REGIONAL NCEP MASS NETCDF TEST
------------------------------
Script  :  /global/save/wx20rt/gsi_anl/sorc/gsi_cvs.200610/rungsi_regional_mass_netcdf.sh
Old code:  /global/save/wx20rt/gsi_anl/sorc/gsi_cvs.200609.mist
New code:  /global/save/wx20rt/gsi_anl/sorc/gsi_cvs.200610

Maximum resident set size
old :  271356 Kbytes
new :  280024 Kbytes

Wall clock (24 tasks, blocking=unlimited)
old : 203.873385 seconds
new : 239.218373 seconds

Output from the first iteration of the minimization
old : penalty,grad ,a,b=   1   0 0.211128750281317953E+05 0.955243467528373352E+06 0.256972334983013436E-02 0.000000000000000000E+00
new : penalty,grad ,a,b=   1   0 0.211093368580702772E+05 0.955219471701702452E+06 0.256958587484224085E-02 0.000000000000000000E+00

Output from the final iteration of the minimization
old : penalty,grad ,a,b=   2  50 0.102533444313309537E+05 0.296709645996351910E+02 0.395440756430067049E-02 0.779656787779978155E+00
new : penalty,grad ,a,b=   2  50 0.102517135660622407E+05 0.298750875402665557E+02 0.389903088904509964E-02 0.791619565806777503E+00

NOTES:
 a) The difference in the initial penalties is in the temperature
    penalty term.  The temperature forward operator in the new
    code processes observations according to how they are reported
    - sensible or virtual.  The old code converts all temperature
    observations to virtual.  For those observations without a
    usable moisture value, the model guess is interpolated to the
    temperature observation and used to convert the reported
    sensible temperature to virtual.



REGIONAL NCEP TWODVAR BINARY TEST
---------------------------------
Script  :  /global/save/wx20rt/gsi_anl/sorc/gsi_cvs.200610/rungsi_regional_twodvar_binary.sh
Old code:  /global/save/wx20rt/gsi_anl/sorc/gsi_cvs.200609.mist
New code:  /global/save/wx20rt/gsi_anl/sorc/gsi_cvs.200610

Maximum resident set size
old :  337256 Kbytes
new :  335908 Kbytes

Wall clock (24 tasks, blocking=unlimited)
old :  256.619905 seconds
new :  374.413287 seconds

Output from the first iteration of the minimization
old : penalty,grad ,a,b=   1   0 0.236340780534119222E+05 0.168594147993461520E+06 0.197434615576350912E-01 0.000000000000000000E+00
new : penalty,grad ,a,b=   1   0 0.236148534156067362E+05 0.167572165012371348E+06 0.197499397269638478E-01 0.000000000000000000E+00

Output from the final iteration of the minimization
old : penalty,grad ,a,b=   2 100 0.131589284728513412E+05 0.185457503254936318E-01 0.109142687616158949E-01 0.539751685827334349E+00
new : penalty,grad ,a,b=   2 100 0.131470074389653473E+05 0.962227692653297635E-03 0.156152037928666831E-01 0.901552513166688385E+00

NOTES:
 a) The difference in the initial penalties is in the temperature
    penalty term.  The temperature forward operator in the new
    code processes observations according to how they are reported
    - sensible or virtual.  The old code converts all temperature
    observations to virtual.  For those observations without a
    usable moisture value, the model guess is interpolated to the
    temperature observation and used to convert the reported
    sensible temperature to virtual.
